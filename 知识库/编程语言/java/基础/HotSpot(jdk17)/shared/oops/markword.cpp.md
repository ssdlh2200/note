# markword.cpp
## 简介markword
```cpp
class markWord {  
 private:  
  uintptr_t _value; //typedef unsigned int uintptr_t;
}
```
mark word描述了Java对象的对象头（Object Header）
- 32为mark word位布局
```text
normal object
|------------------|-----------|---------------|----| 
|     hashcode:25  |   age:4   | biased_lock:0 | 01 |  
|------------------|-----------|---------------|----|

biased object(偏向锁)
|------------------|-----------|---------------|----|  
|thread:23 |epoch:2|   age:4   | biased_lock:1 | 01 | 
|------------------|-----------|---------------|----|

lightweight locked
|------------------|-----------|---------------|----|
|            prt_to_lock_record:30             | 00 |  
|----------------------------------------------|----|

monitor(heavyweight locked)
|------------------|-----------|---------------|----| 
|            prt_to_heavyweight_monitor:30     | 10 |
|------------------|-----------|---------------|----|
 
mark for gc
|----------------------------------------------|----| 
|                                              | 11 | 
|----------------------------------------------|----|
```
- 64位mark word位布局
```
unused: 25 | hash: 31 | unused_gap: 1 | age: 4 | biased_lock: 1 | lock: 2

JavaThread*: 54 | epoch: 2 | unused_gap: 1 | age: 4 | biased_lock: 1 | lock: 2
```
<font color="#c00000">jdk17废除偏向锁</font>
偏向锁模式用于把锁偏向某个线程，低3位表示锁状态
- 锁可以偏向某个特定线程，也可以匿名偏向，表示锁有可能偏向某线程
- 当锁偏向某线程时，该线程可以直接加锁和解锁， 无需使用原子操作
当偏向锁被撤销后，对象会恢复到普通所状态
- 如果其他线程竞争锁，偏向锁会撤销并升级为轻量级或重量级锁
>注意我们对未锁定状态进行了重载，利用age的位空间来区分真正未锁定对象和偏向锁对象
>偏向锁状态下依然包含对象头age位，如果没有age位，JVM会给所有偏向对象分配任意年龄，导致年轻代回收效率下降，如果这些对象占用eden空间过多，晋升不及时，从而增加复制量
```text
[JavaThread* | epoch | age | 1 | 01]   锁偏向某线程
[0           | epoch | age | 1 | 01]   锁匿名偏向
```
低2位用于表示锁的三种状态
```
[ptr             | 00]  locked    指针指向栈上真实对象头
[header      | 0 | 01]  unlocked  普通对象头
[ptr             | 10]  monitor   重量级锁，对象头被替换
[ptr             | 11]  marked    对象被标记回收
[0 ............ 0| 00]  inflating 锁膨胀中（正在创建重量级锁）
```

